<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research & Talent Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; }
        .result-card { transition: all 0.2s; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .gradient-text { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
                <h1 class="text-3xl font-bold">üî¨ Research & Talent Discovery</h1>
                <p class="text-blue-100 text-sm">Find papers, authors, and build your network</p>
            </div>

            <div id="configPanel" class="p-6 bg-slate-50 border-b">
                <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Configuration</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm mb-1">Airtable API Key</label><input type="password" id="airtableKey" placeholder="patXXX" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">Base ID</label><input type="text" id="airtableBase" placeholder="appXXX" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">Publications Table</label><input type="text" id="pubTable" value="Conference Publications" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">Candidates Table</label><input type="text" id="candTable" value="Candidates" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">Affiliations Table</label><input type="text" id="affTable" value="Affiliations" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">Labs Table</label><input type="text" id="labsTable" value="Labs" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">SerpAPI Key (Optional)</label><input type="password" id="serpKey" placeholder="For enhanced search" class="w-full px-3 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm mb-1">Semantic Scholar Key (Optional)</label><input type="password" id="semKey" placeholder="For enhanced search" class="w-full px-3 py-2 border rounded-lg"></div>
                </div>
                <button onclick="init()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg">Connect</button>
            </div>

            <div id="modes" class="hidden">
                <div class="flex bg-slate-50">
                    <button onclick="setMode('papers')" id="tab1" class="tab-active flex-1 px-6 py-4 font-semibold">üìÑ Papers</button>
                    <button onclick="setMode('authors')" id="tab2" class="flex-1 px-6 py-4 font-semibold text-gray-600">üë• Authors</button>
                    <button onclick="setMode('similar')" id="tab3" class="flex-1 px-6 py-4 font-semibold text-gray-600">üéØ Similar</button>
                    <button onclick="setMode('network')" id="tab4" class="flex-1 px-6 py-4 font-semibold text-gray-600">üï∏Ô∏è Network</button>
                    <button onclick="setMode('labs')" id="tab5" class="flex-1 px-6 py-4 font-semibold text-gray-600">üî¨ Labs</button>
                </div>
                <div id="mode1" class="p-6"><textarea id="q1" rows="2" class="w-full border rounded p-2 mb-3" placeholder="Find papers on Mamba"></textarea><button onclick="searchPapers()" class="w-full bg-blue-600 text-white py-3 rounded-lg">Search</button></div>
                <div id="mode2" class="p-6 hidden"><textarea id="q2" rows="2" class="w-full border rounded p-2 mb-3" placeholder="Find authors working on SSMs"></textarea><button onclick="searchAuthors()" class="w-full bg-purple-600 text-white py-3 rounded-lg">Search</button></div>
                <div id="mode3" class="p-6 hidden"><p class="text-sm mb-3">Finds papers similar to P0/P1 ranked</p><button onclick="findSimilar()" class="w-full bg-green-600 text-white py-3 rounded-lg">Find Similar</button></div>
                <div id="mode4" class="p-6 hidden"><input id="q4" class="w-full border rounded p-2 mb-3" placeholder="Author name"><button onclick="discoverNet()" class="w-full bg-indigo-600 text-white py-3 rounded-lg">Map Network</button></div>
                <div id="mode5" class="p-6 hidden">
                    <p class="text-sm mb-3 text-gray-600">Discover labs from P0/P1 papers or search for specific labs</p>
                    <div class="space-y-3">
                        <button onclick="discoverLabs()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg">üîç Discover Labs from P0/P1 Papers</button>
                        <div class="border-t pt-3">
                            <input id="labSearch" class="w-full border rounded p-2 mb-2" placeholder="Search for labs (e.g., Goomba Labs, MIT CSAIL)">
                            <button onclick="searchLabs()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg">Search Specific Labs</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="logs" class="p-6 bg-slate-50 border-t hidden"><h3 class="font-semibold mb-2">Logs</h3><div id="logBox" class="bg-white border rounded p-3 max-h-60 overflow-y-auto text-sm"></div></div>
            
            <div id="review" class="p-6 border-t hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">üìã Review & Approve</h3>
                    <div class="flex gap-2">
                        <button onclick="approveAll()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">‚úì Approve All</button>
                        <button onclick="denyAll()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">‚úó Deny All</button>
                    </div>
                </div>
                <div id="reviewBox" class="space-y-3 max-h-96 overflow-y-auto"></div>
                <button onclick="submitApproved()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg">Submit Approved Items</button>
            </div>
            
            <div id="results" class="p-6 hidden"><h3 id="resTitle" class="text-xl font-bold mb-4"></h3><div id="resBox"></div></div>
        </div>
    </div>
    <script>
const cfg={key:'',base:'',pub:'',cand:'',aff:'',labs:'',serp:'',sem:''};
let fm={p:{title:'',abstract:'',authors:'',authorsLinked:'',date:'',url:''},c:{name:'',affiliation:'',lab:''},a:{name:''},l:{name:'',parent:''}};
let pendingItems={papers:[],authors:[],labs:[]};

function log(m,t='info'){
    document.getElementById('logs').classList.remove('hidden');
    const c={error:'red',success:'green',warning:'yellow'}[t]||'gray';
    document.getElementById('logBox').innerHTML+='<div class="text-'+c+'-600">'+m+'</div>';
}

async function init(){
    cfg.key=document.getElementById('airtableKey').value.trim();
    cfg.base=document.getElementById('airtableBase').value.trim();
    cfg.pub=document.getElementById('pubTable').value.trim();
    cfg.cand=document.getElementById('candTable').value.trim();
    cfg.aff=document.getElementById('affTable').value.trim();
    cfg.labs=document.getElementById('labsTable').value.trim();
    cfg.serp=document.getElementById('serpKey').value.trim();
    cfg.sem=document.getElementById('semKey').value.trim();
    
    if(!cfg.key||!cfg.base)return alert('Enter credentials');
    
    try{
        log('Connecting...');
        const r=await fetch('https://api.airtable.com/v0/meta/bases/'+cfg.base+'/tables',{headers:{'Authorization':'Bearer '+cfg.key}});
        if(!r.ok)throw new Error('HTTP '+r.status);
        const d=await r.json();
        
        const pt=d.tables.find(t=>t.name===cfg.pub);
        if(pt){
            fm.p.title=(pt.fields.find(f=>f.name.toLowerCase().includes('title'))||{}).name||'';
            fm.p.abstract=(pt.fields.find(f=>f.name.toLowerCase().includes('abstract'))||{}).name||'';
            fm.p.authors=(pt.fields.find(f=>f.name.toLowerCase().includes('author')&&f.type!=='multipleRecordLinks')||{}).name||'';
            fm.p.authorsLinked=(pt.fields.find(f=>f.name.toLowerCase().includes('author')&&f.type==='multipleRecordLinks')||{}).name||'';
            fm.p.date=(pt.fields.find(f=>f.name.toLowerCase().includes('date')||f.name.toLowerCase().includes('year'))||{}).name||'';
            fm.p.url=(pt.fields.find(f=>f.name.toLowerCase().includes('url')||f.name.toLowerCase().includes('link'))||{}).name||'';
            if(fm.p.authorsLinked)log('‚úì Found linked Authors field: '+fm.p.authorsLinked,'success');
        }
        
        const ct=d.tables.find(t=>t.name===cfg.cand);
        if(ct){
            fm.c.name=(ct.fields.find(f=>f.name.toLowerCase().includes('full name')||f.name.toLowerCase().includes('name'))||ct.fields[0]).name;
            fm.c.affiliation=(ct.fields.find(f=>f.type==='multipleRecordLinks'&&(f.name.toLowerCase().includes('affiliation')||f.name.toLowerCase().includes('institution')))||{}).name||'';
            fm.c.lab=(ct.fields.find(f=>f.type==='multipleRecordLinks'&&f.name.toLowerCase().includes('lab'))||{}).name||'';
            if(fm.c.affiliation)log('‚úì Found linked Affiliation field: '+fm.c.affiliation,'success');
            if(fm.c.lab)log('‚úì Found linked Lab field: '+fm.c.lab,'success');
        }
        
        const at=d.tables.find(t=>t.name===cfg.aff);
        if(at)fm.a.name=(at.fields.find(f=>f.name.toLowerCase().includes('name'))||at.fields[0]).name;
        
        const lt=d.tables.find(t=>t.name===cfg.labs);
        if(lt){
            fm.l.name=(lt.fields.find(f=>f.name.toLowerCase().includes('name'))||lt.fields[0]).name;
            fm.l.parent=(lt.fields.find(f=>f.type==='multipleRecordLinks'&&(f.name.toLowerCase().includes('parent')||f.name.toLowerCase().includes('affiliation')||f.name.toLowerCase().includes('institution')))||{}).name||'';
            if(fm.l.parent)log('‚úì Found linked Parent Institution field: '+fm.l.parent,'success');
        }
        
        document.getElementById('modes').classList.remove('hidden');
        log('Connected!','success');
    }catch(e){
        log('Error: '+e.message,'error');
    }
}

async function findOrCreateCandidate(authorName){
    if(!authorName||authorName.length<2||!fm.c.name)return null;
    try{
        const searchUrl='https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.cand)+'?filterByFormula='+encodeURIComponent('{'+fm.c.name+'}="'+authorName.replace(/"/g,'\\"')+'"');
        const searchResponse=await fetch(searchUrl,{headers:{'Authorization':'Bearer '+cfg.key}});
        if(searchResponse.ok){
            const searchData=await searchResponse.json();
            if(searchData.records&&searchData.records.length>0)return searchData.records[0].id;
        }
        const createResponse=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.cand),{
            method:'POST',
            headers:{'Authorization':'Bearer '+cfg.key,'Content-Type':'application/json'},
            body:JSON.stringify({fields:{[fm.c.name]:authorName}})
        });
        if(createResponse.ok){
            const createData=await createResponse.json();
            return createData.id;
        }
    }catch(error){
        log('Error with candidate: '+error.message,'error');
    }
    return null;
}

async function findOrCreateAffiliation(affiliationName){
    if(!affiliationName||affiliationName.length<2||!fm.a.name)return null;
    try{
        const searchUrl='https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.aff)+'?filterByFormula='+encodeURIComponent('{'+fm.a.name+'}="'+affiliationName.replace(/"/g,'\\"')+'"');
        const searchResponse=await fetch(searchUrl,{headers:{'Authorization':'Bearer '+cfg.key}});
        if(searchResponse.ok){
            const searchData=await searchResponse.json();
            if(searchData.records&&searchData.records.length>0)return searchData.records[0].id;
        }
        const createResponse=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.aff),{
            method:'POST',
            headers:{'Authorization':'Bearer '+cfg.key,'Content-Type':'application/json'},
            body:JSON.stringify({fields:{[fm.a.name]:affiliationName}})
        });
        if(createResponse.ok){
            const createData=await createResponse.json();
            return createData.id;
        }
    }catch(error){
        log('Error with affiliation: '+error.message,'error');
    }
    return null;
}

async function findOrCreateLab(labName,parentInstitutionName){
    if(!labName||labName.length<2||!fm.l.name)return null;
    try{
        let parentAffiliationId=null;
        if(parentInstitutionName&&fm.l.parent){
            parentAffiliationId=await findOrCreateAffiliation(parentInstitutionName);
        }
        const searchUrl='https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.labs)+'?filterByFormula='+encodeURIComponent('{'+fm.l.name+'}="'+labName.replace(/"/g,'\\"')+'"');
        const searchResponse=await fetch(searchUrl,{headers:{'Authorization':'Bearer '+cfg.key}});
        if(searchResponse.ok){
            const searchData=await searchResponse.json();
            if(searchData.records&&searchData.records.length>0)return searchData.records[0].id;
        }
        const fields={[fm.l.name]:labName};
        if(parentAffiliationId&&fm.l.parent)fields[fm.l.parent]=[parentAffiliationId];
        const createResponse=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.labs),{
            method:'POST',
            headers:{'Authorization':'Bearer '+cfg.key,'Content-Type':'application/json'},
            body:JSON.stringify({fields:fields})
        });
        if(createResponse.ok){
            const createData=await createResponse.json();
            return createData.id;
        }
    }catch(error){
        log('Error with lab: '+error.message,'error');
    }
    return null;
}

function setMode(m){
    ['tab1','tab2','tab3','tab4','tab5'].forEach((t,i)=>{
        document.getElementById(t).className=(m===['papers','authors','similar','network','labs'][i]?'tab-active ':'')+'flex-1 px-6 py-4 font-semibold'+(m!=['papers','authors','similar','network','labs'][i]?' text-gray-600':'');
    });
    ['mode1','mode2','mode3','mode4','mode5'].forEach((d,i)=>{
        document.getElementById(d).classList[m===['papers','authors','similar','network','labs'][i]?'remove':'add']('hidden');
    });
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function searchPapers(){
    const q=document.getElementById('q1').value.trim();
    if(!q)return;
    document.getElementById('logBox').innerHTML='';
    log('Searching papers thoroughly...');
    const terms=extractTerms(q);
    const papers=[];
    for(let t of terms){
        log('ArXiv search: '+t);
        const r=await arxiv(t,20);
        papers.push(...r);
        await sleep(1000);
        if(cfg.serp){
            log('SerpAPI search: '+t);
            const s=await serpSearch(t,10);
            papers.push(...s);
            await sleep(1000);
        }
        if(cfg.sem){
            log('Semantic Scholar search: '+t);
            const ss=await semSearch(t,10);
            papers.push(...ss);
            await sleep(1000);
        }
    }
    const uniq=Array.from(new Map(papers.map(p=>[p.title.toLowerCase(),p])).values());
    log('Found '+uniq.length+' unique papers','success');
    pendingItems.papers=uniq;
    pendingItems.authors=[];
    pendingItems.labs=[];
    showReview();
}

async function searchAuthors(){
    const q=document.getElementById('q2').value.trim();
    if(!q)return;
    document.getElementById('logBox').innerHTML='';
    log('Searching authors thoroughly...');
    const terms=extractTerms(q);
    const amap={};
    for(let t of terms){
        log('ArXiv author search: '+t);
        const pps=await arxiv(t,30);
        pps.forEach(p=>{
            const authorList=typeof p.authors==='string'?p.authors.split(','):[];
            authorList.forEach(a=>{
                const n=a.trim();
                if(n&&n!=='Unknown'){
                    if(!amap[n])amap[n]={name:n,papers:[],topics:new Set()};
                    amap[n].papers.push(p);
                    amap[n].topics.add(t);
                }
            });
        });
        await sleep(1500);
        if(cfg.serp){
            log('SerpAPI author search: '+t);
            const s=await serpSearch(t,20);
            s.forEach(p=>{
                const authorList=typeof p.authors==='string'?p.authors.split(','):[];
                authorList.forEach(a=>{
                    const n=a.trim();
                    if(n&&n!=='Unknown'){
                        if(!amap[n])amap[n]={name:n,papers:[],topics:new Set()};
                        amap[n].papers.push(p);
                        amap[n].topics.add(t);
                    }
                });
            });
            await sleep(1500);
        }
    }
    const auths=Object.values(amap).filter(a=>a.papers.length>=3).map(a=>({name:a.name,paperCount:a.papers.length,topics:Array.from(a.topics),score:a.papers.length*a.topics.size})).sort((a,b)=>b.score-a.score).slice(0,30);
    log('Found '+auths.length+' authors','success');
    pendingItems.papers=[];
    pendingItems.authors=auths;
    pendingItems.labs=[];
    showReview();
}

async function findSimilar(){
    document.getElementById('logBox').innerHTML='';
    log('Analyzing P0/P1 thoroughly...');
    try{
        const r=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.pub)+'?filterByFormula=OR({Karan\'s Notes}="P0",{Karan\'s Notes}="P1")',{headers:{'Authorization':'Bearer '+cfg.key}});
        if(!r.ok)throw new Error('HTTP '+r.status);
        const d=await r.json();
        if(d.records.length===0)return log('No P0/P1 found','warning');
        const authors=[];
        const terms=[];
        d.records.forEach(rec=>{
            const aut=rec.fields[fm.p.authors]||'';
            if(typeof aut==='string'){
                aut.split(',').forEach(a=>authors.push(a.trim()));
            }
            const txt=((rec.fields[fm.p.title]||'')+' '+(rec.fields[fm.p.abstract]||'')).toLowerCase();
            [/mamba/gi,/state space/gi,/s4/gi,/attention/gi,/selective/gi,/hybrid/gi].forEach(pat=>{
                const m=txt.match(pat);
                if(m)m.forEach(x=>terms.push(x.toLowerCase()));
            });
        });
        const acount={};
        authors.forEach(a=>{acount[a]=(acount[a]||0)+1;});
        const top=Object.keys(acount).sort((a,b)=>acount[b]-acount[a]).slice(0,8);
        const uterms=Array.from(new Set(terms)).slice(0,8);
        log('Top authors: '+top.join(', '));
        log('Key terms: '+uterms.join(', '));
        const papers=[];
        const amap={};
        for(let a of top){
            log('Searching author: '+a);
            const r=await arxiv('au:'+a,20);
            papers.push(...r);
            r.forEach(p=>{
                const authorList=typeof p.authors==='string'?p.authors.split(','):[];
                authorList.forEach(au=>{
                    const n=au.trim();
                    if(n&&n!=='Unknown'){
                        if(!amap[n])amap[n]={name:n,papers:[],topics:new Set()};
                        amap[n].papers.push(p);
                        uterms.forEach(t=>amap[n].topics.add(t));
                    }
                });
            });
            await sleep(2000);
        }
        for(let t of uterms){
            log('Searching term: '+t);
            const r=await arxiv(t,20);
            papers.push(...r);
            await sleep(2000);
            if(cfg.serp){
                const s=await serpSearch(t,15);
                papers.push(...s);
                await sleep(1500);
            }
        }
        const uniq=Array.from(new Map(papers.map(p=>[p.title.toLowerCase(),p])).values());
        const auths=Object.values(amap).filter(a=>a.papers.length>=2).map(a=>({name:a.name,paperCount:a.papers.length,topics:Array.from(a.topics),score:a.papers.length*a.topics.size})).sort((a,b)=>b.score-a.score).slice(0,30);
        log('Found '+uniq.length+' papers, '+auths.length+' authors','success');
        pendingItems.papers=uniq;
        pendingItems.authors=auths;
        pendingItems.labs=[];
        showReview();
    }catch(e){
        log('Error: '+e.message,'error');
    }
}

async function discoverNet(){
    const a=document.getElementById('q4').value.trim();
    if(!a)return;
    document.getElementById('logBox').innerHTML='';
    log('Mapping network for '+a);
    const net={authors:{}};
    net.authors[a]={name:a,level:0,papers:[]};
    const pps=await arxiv('au:'+a,50);
    net.authors[a].papers=pps;
    const collabs={};
    pps.forEach(p=>{
        const authorList=typeof p.authors==='string'?p.authors.split(','):[];
        authorList.forEach(au=>{
            const n=au.trim();
            if(n&&n!==a&&n!=='Unknown'){
                if(!collabs[n])collabs[n]=0;
                collabs[n]++;
            }
        });
    });
    const top=Object.keys(collabs).filter(c=>collabs[c]>=2).sort((x,y)=>collabs[y]-collabs[x]).slice(0,15);
    log('Found '+top.length+' collaborators');
    for(let c of top)net.authors[c]={name:c,level:1,papers:[],collabCount:collabs[c]};
    const auths=Object.values(net.authors).map(au=>({name:au.name,paperCount:au.papers.length,topics:[]}));
    pendingItems.papers=[];
    pendingItems.authors=auths;
    pendingItems.labs=[];
    showReview();
}

function showReview(){
    document.getElementById('review').classList.remove('hidden');
    document.getElementById('results').classList.add('hidden');
    let h='';
    if(pendingItems.papers.length>0){
        h+='<div class="mb-6"><h4 class="font-bold text-lg mb-3">Papers ('+pendingItems.papers.length+')</h4>';
        pendingItems.papers.forEach((p,i)=>{
            h+='<div class="bg-white border-2 rounded-lg p-4 mb-3" id="p'+i+'"><div class="flex justify-between items-start mb-2"><div class="flex-1"><h5 class="font-semibold text-blue-900">'+esc(p.title)+'</h5><p class="text-xs text-gray-600 mt-1">'+esc(String(p.authors).substring(0,80))+'... ‚Ä¢ '+p.date+'</p></div><div class="flex gap-2"><button onclick="approvePaper('+i+')" class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm">‚úì</button><button onclick="denyPaper('+i+')" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">‚úó</button></div></div><p class="text-sm text-gray-700">'+esc(p.abstract.substring(0,150))+'...</p></div>';
        });
        h+='</div>';
    }
    if(pendingItems.authors.length>0){
        h+='<div><h4 class="font-bold text-lg mb-3">Authors ('+pendingItems.authors.length+')</h4>';
        pendingItems.authors.forEach((a,i)=>{
            h+='<div class="bg-purple-50 border-2 rounded-lg p-4 mb-3" id="a'+i+'"><div class="flex justify-between items-center"><div><h5 class="font-semibold text-purple-900">'+esc(a.name)+'</h5><p class="text-xs text-gray-600">'+a.paperCount+' papers ‚Ä¢ Score: '+a.score+'</p></div><div class="flex gap-2"><button onclick="approveAuthor('+i+')" class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm">‚úì</button><button onclick="denyAuthor('+i+')" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">‚úó</button></div></div></div>';
        });
        h+='</div>';
    }
    if(pendingItems.labs.length>0){
        h+='<div><h4 class="font-bold text-lg mb-3">Labs ('+pendingItems.labs.length+')</h4>';
        pendingItems.labs.forEach((l,i)=>{
            h+='<div class="bg-orange-50 border-2 rounded-lg p-4 mb-3" id="l'+i+'"><div class="flex justify-between items-center"><div><h5 class="font-semibold text-orange-900">'+esc(l.name)+'</h5><p class="text-xs text-gray-600">'+esc(l.institution||'Institution TBD')+' ‚Ä¢ '+l.papers+' papers</p></div><div class="flex gap-2"><button onclick="approveLab('+i+')" class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm">‚úì</button><button onclick="denyLab('+i+')" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">‚úó</button></div></div></div>';
        });
        h+='</div>';
    }
    document.getElementById('reviewBox').innerHTML=h;
}

function approvePaper(i){
    document.getElementById('p'+i).classList.remove('border-2');
    document.getElementById('p'+i).classList.add('border-4','border-green-500');
    pendingItems.papers[i].approved=true;
}

function denyPaper(i){
    document.getElementById('p'+i).style.opacity='0.3';
    pendingItems.papers[i].approved=false;
}

function approveAuthor(i){
    document.getElementById('a'+i).classList.remove('border-2');
    document.getElementById('a'+i).classList.add('border-4','border-green-500');
    pendingItems.authors[i].approved=true;
}

function denyAuthor(i){
    document.getElementById('a'+i).style.opacity='0.3';
    pendingItems.authors[i].approved=false;
}

function approveLab(i){
    document.getElementById('l'+i).classList.remove('border-2');
    document.getElementById('l'+i).classList.add('border-4','border-green-500');
    pendingItems.labs[i].approved=true;
}

function denyLab(i){
    document.getElementById('l'+i).style.opacity='0.3';
    pendingItems.labs[i].approved=false;
}

function approveAll(){
    pendingItems.papers.forEach((p,i)=>approvePaper(i));
    pendingItems.authors.forEach((a,i)=>approveAuthor(i));
    pendingItems.labs.forEach((l,i)=>approveLab(i));
}

function denyAll(){
    pendingItems.papers.forEach((p,i)=>denyPaper(i));
    pendingItems.authors.forEach((a,i)=>denyAuthor(i));
    pendingItems.labs.forEach((l,i)=>denyLab(i));
}

async function submitApproved(){
    const apPapers=pendingItems.papers.filter(p=>p.approved);
    const apAuthors=pendingItems.authors.filter(a=>a.approved);
    const apLabs=pendingItems.labs.filter(l=>l.approved);
    log('Submitting '+apPapers.length+' papers, '+apAuthors.length+' authors, '+apLabs.length+' labs...');
    if(apLabs.length>0)await addLabs(apLabs);
    if(apPapers.length>0)await addPapers(apPapers);
    if(apAuthors.length>0)await addAuthors(apAuthors);
    document.getElementById('review').classList.add('hidden');
    log('‚úì Submission complete!','success');
}

async function serpSearch(q,max){
    if(!cfg.serp)return[];
    try{
        const r=await fetch('https://serpapi.com/search.json?engine=google_scholar&q='+encodeURIComponent(q)+'&num='+max+'&api_key='+cfg.serp);
        if(!r.ok)return[];
        const d=await r.json();
        return(d.organic_results||[]).map(p=>({
            title:p.title||'',
            abstract:p.snippet||'',
            authors:p.publication_info?.authors?.map(a=>a.name).join(', ')||'Unknown',
            date:p.publication_info?.summary?.match(/\d{4}/)?.[0]||'',
            url:p.link||'',
            source:'Google Scholar'
        }));
    }catch(e){
        log('SerpAPI error','error');
        return[];
    }
}

async function semSearch(q,max){
    if(!cfg.sem)return[];
    try{
        const r=await fetch('https://api.semanticscholar.org/graph/v1/paper/search?query='+encodeURIComponent(q)+'&limit='+max+'&fields=title,abstract,authors,year,url',{headers:{'x-api-key':cfg.sem}});
        if(!r.ok)return[];
        const d=await r.json();
        if(!d.data)return[];
        return d.data.map(p=>({
            title:p.title||'',
            abstract:p.abstract||'',
            authors:p.authors?.map(a=>a.name).join(', ')||'Unknown',
            date:p.year?p.year.toString():'',
            url:p.url||'',
            source:'Semantic Scholar'
        }));
    }catch(e){
        log('Semantic error','error');
        return[];
    }
}

async function discoverLabs(){
    document.getElementById('logBox').innerHTML='';
    log('üî¨ Discovering labs from P0/P1 papers...');
    try{
        const r=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.pub)+'?filterByFormula=OR({Karan\'s Notes}="P0",{Karan\'s Notes}="P1")',{headers:{'Authorization':'Bearer '+cfg.key}});
        if(!r.ok)throw new Error('HTTP '+r.status);
        const d=await r.json();
        if(d.records.length===0)return log('No P0/P1 found','warning');
        log('Analyzing '+d.records.length+' papers for lab affiliations...');
        const labMap={};
        d.records.forEach(rec=>{
            const aut=rec.fields[fm.p.authors]||'';
            if(typeof aut==='string'){
                const authors=aut.split(',').map(a=>a.trim()).filter(a=>a);
                authors.forEach(author=>{
                    const affMatch=author.match(/\(([^)]+)\)/);
                    if(affMatch){
                        const aff=affMatch[1];
                        parseLab(aff,labMap);
                    }
                });
            }
        });
        const labs=Object.keys(labMap).map(name=>({
            name:name,
            institution:labMap[name].inst,
            papers:labMap[name].papers,
            approved:false
        }));
        log('Found '+labs.length+' unique labs','success');
        pendingItems.labs=labs;
        pendingItems.papers=[];
        pendingItems.authors=[];
        showReview();
    }catch(e){
        log('Error: '+e.message,'error');
    }
}

async function searchLabs(){
    const q=document.getElementById('labSearch').value.trim();
    if(!q)return;
    document.getElementById('logBox').innerHTML='';
    log('üî¨ Searching for lab: '+q);
    const labs=[{name:q,institution:'',papers:0,approved:false}];
    log('Searching for researchers from '+q+'...');
    const researchers=await findLabResearchers(q);
    log('Found '+researchers.length+' researchers from '+q,'success');
    pendingItems.labs=labs;
    pendingItems.authors=researchers;
    pendingItems.papers=[];
    showReview();
}

function parseLab(affStr,labMap){
    const parts=affStr.split(',').map(s=>s.trim());
    if(parts.length>=2){
        const labName=parts[0];
        const instName=parts[parts.length-1];
        if(!labMap[labName]){
            labMap[labName]={inst:instName,papers:1};
        }else{
            labMap[labName].papers++;
        }
    }
}

async function findLabResearchers(labName){
    log('Searching ArXiv for '+labName+' publications...');
    const papers=await arxiv(labName,50);
    const amap={};
    papers.forEach(p=>{
        const authorList=typeof p.authors==='string'?p.authors.split(','):[];
        authorList.forEach(a=>{
            const n=a.trim();
            if(n&&n!=='Unknown'){
                if(!amap[n])amap[n]={name:n,papers:[],topics:new Set()};
                amap[n].papers.push(p);
            }
        });
    });
    return Object.values(amap).filter(a=>a.papers.length>=2).map(a=>({
        name:a.name,
        paperCount:a.papers.length,
        topics:[labName],
        score:a.papers.length,
        lab:labName,
        approved:false
    }));
}

function extractTerms(p){
    const t=[];
    const ids=p.match(/arxiv\.org\/abs\/(\d+\.\d+)/gi);
    if(ids)ids.forEach(id=>t.push('arxiv:'+id.replace(/arxiv\.org\/abs\//i,'')));
    const qt=p.match(/"([^"]+)"/g);
    if(qt)qt.forEach(q=>t.push(q.replace(/"/g,'')));
    const tech=p.match(/\b(mamba|ssm|s4|transformer|attention|architecture|lstm|rnn)\b/gi);
    if(tech)tech.forEach(x=>t.push(x.toLowerCase()));
    if(ids&&ids.length>0&&t.length===ids.length){
        t.push('state space model');
        t.push('sequential model');
    }
    return t.length>0?Array.from(new Set(t)):[p];
}

async function arxiv(q,max){
    try{
        if(q.startsWith('arxiv:')){
            const id=q.replace('arxiv:','');
            const r=await fetch('https://export.arxiv.org/api/query?id_list='+id);
            const txt=await r.text();
            const xml=new DOMParser().parseFromString(txt,'text/xml');
            const e=xml.querySelector('entry');
            if(e){
                const t=e.querySelector('title')?.textContent.trim();
                const s=e.querySelector('summary')?.textContent.trim();
                const d=e.querySelector('published')?.textContent;
                const l=e.querySelector('id')?.textContent;
                const a=Array.from(e.querySelectorAll('author name')).map(x=>x.textContent);
                if(t&&s)return[{title:t,abstract:s,authors:a.join(', '),date:d?d.split('T')[0]:'',url:l,source:'arXiv'}];
            }
            return[];
        }
        let sq=q.startsWith('au:')?'au:'+encodeURIComponent(q.replace('au:','')):'all:'+encodeURIComponent(q);
        const r=await fetch('https://export.arxiv.org/api/query?search_query='+sq+'&start=0&max_results='+max+'&sortBy=submittedDate&sortOrder=descending');
        const txt=await r.text();
        const xml=new DOMParser().parseFromString(txt,'text/xml');
        const entries=xml.querySelectorAll('entry');
        const pps=[];
        entries.forEach(e=>{
            const t=e.querySelector('title')?.textContent.trim();
            const s=e.querySelector('summary')?.textContent.trim();
            const d=e.querySelector('published')?.textContent;
            const l=e.querySelector('id')?.textContent;
            const a=Array.from(e.querySelectorAll('author name')).map(x=>x.textContent);
            if(t&&s)pps.push({title:t,abstract:s,authors:a.join(', '),date:d?d.split('T')[0]:'',url:l,source:'arXiv'});
        });
        return pps;
    }catch(e){
        log('ArXiv error: '+e.message,'error');
        return[];
    }
}

function esc(txt){
    const d=document.createElement('div');
    d.textContent=txt;
    return d.innerHTML;
}

async function addPapers(pps){
    log('Adding '+pps.length+' papers...');
    const ex=await fetchEx(cfg.pub);
    let add=0,skip=0;
    for(let p of pps){
        if(ex.has(p.title.toLowerCase())){
            skip++;
            continue;
        }
        try{
            const flds={};
            if(fm.p.title)flds[fm.p.title]=p.title;
            if(fm.p.abstract)flds[fm.p.abstract]=p.abstract;
            if(fm.p.date)flds[fm.p.date]=p.date;
            if(fm.p.url)flds[fm.p.url]=p.url;
            
            if(fm.p.authorsLinked&&p.authors){
                const authorNames=typeof p.authors==='string'?p.authors.split(',').map(a=>a.trim()):[];
                const authorIds=[];
                for(let authorName of authorNames){
                    if(authorName&&authorName!=='Unknown'){
                        const candId=await findOrCreateCandidate(authorName);
                        if(candId)authorIds.push(candId);
                        await sleep(200);
                    }
                }
                if(authorIds.length>0)flds[fm.p.authorsLinked]=authorIds;
            }else if(fm.p.authors){
                flds[fm.p.authors]=p.authors;
            }
            
            const r=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.pub),{
                method:'POST',
                headers:{'Authorization':'Bearer '+cfg.key,'Content-Type':'application/json'},
                body:JSON.stringify({fields:flds})
            });
            if(r.ok)add++;
            await sleep(300);
        }catch(e){
            log('Add error: '+e.message,'error');
        }
    }
    log('Added '+add+', skipped '+skip,'success');
}

async function addAuthors(auths){
    log('Adding '+auths.length+' authors...');
    const ex=await fetchEx(cfg.cand,true);
    let add=0,skip=0;
    for(let a of auths){
        if(ex.has(a.name.toLowerCase())){
            skip++;
            continue;
        }
        try{
            const flds={};
            if(fm.c.name)flds[fm.c.name]=a.name;
            
            if(a.affiliation&&fm.c.affiliation){
                const affId=await findOrCreateAffiliation(a.affiliation);
                if(affId)flds[fm.c.affiliation]=[affId];
                await sleep(200);
            }
            
            if(a.lab&&fm.c.lab){
                const labId=await findOrCreateLab(a.lab,a.affiliation||'');
                if(labId)flds[fm.c.lab]=[labId];
                await sleep(200);
            }
            
            const r=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.cand),{
                method:'POST',
                headers:{'Authorization':'Bearer '+cfg.key,'Content-Type':'application/json'},
                body:JSON.stringify({fields:flds})
            });
            if(r.ok)add++;
            await sleep(300);
        }catch(e){
            log('Add error: '+e.message,'error');
        }
    }
    log('Added '+add+', skipped '+skip,'success');
}

async function addLabs(labs){
    log('Adding '+labs.length+' labs...');
    for(let lab of labs){
        try{
            let affId=null;
            if(lab.institution&&fm.l.parent){
                affId=await findOrCreateAffiliation(lab.institution);
                await sleep(200);
            }
            
            const existingLabId=await findExistingLab(lab.name);
            if(existingLabId){
                log('Lab already exists: '+lab.name,'warning');
                continue;
            }
            
            const flds={};
            if(fm.l.name)flds[fm.l.name]=lab.name;
            if(fm.l.parent&&affId)flds[fm.l.parent]=[affId];
            
            const r=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.labs),{
                method:'POST',
                headers:{'Authorization':'Bearer '+cfg.key,'Content-Type':'application/json'},
                body:JSON.stringify({fields:flds})
            });
            if(r.ok)log('Created lab: '+lab.name,'success');
            await sleep(300);
        }catch(e){
            log('Lab add error: '+e.message,'error');
        }
    }
    log('‚úì Labs added','success');
}

async function findExistingLab(name){
    try{
        const searchUrl='https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(cfg.labs)+'?filterByFormula='+encodeURIComponent('{'+fm.l.name+'}="'+name.replace(/"/g,'\\"')+'"');
        const r=await fetch(searchUrl,{headers:{'Authorization':'Bearer '+cfg.key}});
        if(r.ok){
            const d=await r.json();
            return d.records.length>0?d.records[0].id:null;
        }
        return null;
    }catch(e){
        return null;
    }
}

async function fetchEx(tbl,isCand=false){
    try{
        const r=await fetch('https://api.airtable.com/v0/'+cfg.base+'/'+encodeURIComponent(tbl),{headers:{'Authorization':'Bearer '+cfg.key}});
        if(!r.ok)return new Set();
        const d=await r.json();
        const s=new Set();
        d.records.forEach(rec=>{
            const val=isCand?rec.fields[fm.c.name]:rec.fields[fm.p.title];
            if(val)s.add(val.toLowerCase().trim());
        });
        return s;
    }catch(e){
        return new Set();
    }
}
    </script>
</body>
</html>
            